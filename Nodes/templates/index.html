<!doctype html>
<title>ADMIN TOOLS :D</title>
<h1>Admin page</h1>
<script src="templates/jquery-3.1.1.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
<style>
th {
    text-align: left;
    padding-right: 20px;
}

</style>

<b>Do a tick;</b>
<form action="startTick" method = "post">
    <input type="submit" value="Start a Tick">
</form>
<br/>
<p></p>
<table id = "records_table">
    <thead>
        <tr>
            <th>Name</th>
            <th>Temperature</th>
            <th>Amount stored</th>
            <th>Enabled</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>

<div id="message"></div>
<canvas id="chart"></canvas>
<script>
    var default_node = "generator";
    var current_node = null;
    var chart = null;
    // Handle the POST calls of all forms
    $(document).on("submit", "form", function(event)
    {
        event.preventDefault();

        var url=$(this).attr("action");
        $.ajax({
            url: url,
            type: $(this).attr("method"),
            dataType: "JSON",
            data: new FormData(this),
            processData: false,
            contentType: false,
            beforeSend: function()
            {
                $("#message").html("sending...");
            },
            success: function(data)
            {
                $("#message").html("");
                updateNodeData();
                drawTemperatureChart(default_node);
            },
            error: function (xhr, description, error)
            {
                $("#message").html(error);
            }
        });
    });

    function updateNodeData()
    {
        $.get( "/nodes/", function(data) {
            updateTable(data);
        });
    }


    function updateTable(response) {
        // Clear the old data.
        $('#records_table tbody').empty();
        // Parse all the entries.
        $.each(response, function(i, item) {
            var form = $("<form/>", {
                action: item.node_id + '/enabled/',
                method: "put"
            });
            form.append($("<input>", {
                type: "submit",
                value: item.enabled
            }));
            var node_link = $("<a/>", {href: '#', text: item.node_id});
            node_link.click(function(evt){
                evt.preventDefault();
                default_node = item.node_id;
                drawTemperatureChart(default_node);
            });
            $('<tr>').append(
                $('<td>').append(node_link),
                $('<td>').text(item.temperature),
                $('<td>').text(item.amount),
                $('<td>').append(form)
            ).appendTo('#records_table');
        });
    }

    function drawTemperatureChart(node_id) {

        var jsonData = $.ajax({
            url: '/' + node_id + '/temperature/history',
            dataType: 'json',
        }).done(function(results) {

            var label = [];
            var output = [];

            results.forEach(function(data, i) {
                label.push((i + 1).toString());
                output.push(data);
            });

            var data = {
                labels: label,
                datasets: [
                    {
                        label: "temperature",
                        data: output,
                        backgroundColor: "red"
                    }
                ]
            };

            var config = { type: 'bar',  data : data};
            var ctx = $("#chart").get(0).getContext("2d");
            if(current_node !== node_id){
                if(chart != null)
                {
                    chart.destroy();
                }
                current_node = node_id;
                chart = new Chart(ctx, config);
            } else{
                chart.data = data;
                chart.update(0); // Draw with update 0 (we don't want animations)
            }
        });
    }
    function updateAll()
    {
        updateNodeData();
        drawTemperatureChart(default_node);
    }
    updateAll();
</script>